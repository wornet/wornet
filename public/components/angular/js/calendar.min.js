angular.module("ui.calendar",[]).constant("uiCalendarConfig",{}).controller("uiCalendarCtrl",["$scope","$timeout",function(e,t){var n=1,r=1,i=e.eventSources,s=e.calendarWatchEvent?e.calendarWatchEvent:angular.noop,o=function(e){var n;if(e){n=function(){var n=arguments;t(function(){e.apply(this,n)})}}return n};this.eventsFingerprint=function(e){if(!e.__uiCalId){e.__uiCalId=r++}return""+e.__uiCalId+(e.id||"")+(e.title||"")+(e.url||"")+(+e.start||"")+(+e.end||"")+(e.allDay||"")+(e.className||"")+s(e)||""};this.sourcesFingerprint=function(e){return e.__id||(e.__id=n++)};this.allEvents=function(){var e=[];for(var t=0,n=i.length;t<n;t++){var r=i[t];if(angular.isArray(r)){e.push(r)}else if(angular.isObject(r)&&angular.isArray(r.events)){var s={};for(var o in r){if(o!=="_uiCalId"&&o!=="events"){s[o]=r[o]}}for(var u=0;u<r.events.length;u++){angular.extend(r.events[u],s)}e.push(r.events)}}return Array.prototype.concat.apply([],e)};this.changeWatcher=function(e,t){var n;var r=function(){var n=angular.isFunction(e)?e():e;var r=[],i,o;for(var u=0,a=n.length;u<a;u++){o=n[u];i=t(o);s[i]=o;r.push(i)}return r};var i=function(e,t){var n=[],r={},i,s;for(i=0,s=t.length;i<s;i++){r[t[i]]=true}for(i=0,s=e.length;i<s;i++){if(!r[e[i]]){n.push(e[i])}}return n};var s={};var o=function(e,r){var o,u,a,f;var l={};var c=i(r,e);for(o=0,u=c.length;o<u;o++){var h=c[o];a=s[h];delete s[h];var p=t(a);if(p===h){n.onRemoved(a)}else{l[p]=h;n.onChanged(a)}}var d=i(e,r);for(o=0,u=d.length;o<u;o++){f=d[o];a=s[f];if(!l[f]){n.onAdded(a)}}};return n={subscribe:function(e,t){e.$watch(r,function(e,n){if(!t||t(e,n)!==false){o(e,n)}},true)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(e,t){var n={};angular.extend(n,t);angular.extend(n,e);angular.forEach(n,function(e,t){if(typeof e==="function"){n[t]=o(n[t])}});return n}}]).directive("uiCalendar",["uiCalendarConfig","$locale",function(e,t){var n=function(e){var t,n;t=[];for(n in e){t[n]=e[n]}return t};var r=t.DATETIME_FORMATS;e=angular.extend({monthNames:n(r.MONTH),monthNamesShort:n(r.SHORTMONTH),dayNames:n(r.DAY),dayNamesShort:n(r.SHORTDAY)},e||{});return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(t,n,r,i){function l(){var n=r.uiCalendar?t.$parent.$eval(r.uiCalendar):{},o;o=i.getFullCalendarConfig(n,e);f={eventSources:s};angular.extend(f,o);var u={};for(var a in f){if(a!=="eventSources"){u[a]=f[a]}}return JSON.stringify(u)}var s=t.eventSources,o=false,u=i.changeWatcher(s,i.sourcesFingerprint),a=i.changeWatcher(i.allEvents,i.eventsFingerprint),f=null;t.destroy=function(){if(r.calendar){t.calendar=t.$parent[r.calendar]=n.html("")}else{t.calendar=n.html("")}};t.init=function(){t.calendar.fullCalendar(f)};u.onAdded=function(e){t.calendar.fullCalendar("addEventSource",e);o=true};u.onRemoved=function(e){t.calendar.fullCalendar("removeEventSource",e);o=true};a.onAdded=function(e){t.calendar.fullCalendar("renderEvent",e)};a.onRemoved=function(e){t.calendar.fullCalendar("removeEvents",function(t){return t===e})};a.onChanged=function(e){t.calendar.fullCalendar("updateEvent",e)};u.subscribe(t);a.subscribe(t,function(e,t){if(o===true){o=false;return false}});t.$watch(l,function(e,n){t.destroy();t.init()})}}}])